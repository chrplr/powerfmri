Tests of the efficiency of various fMRI designs ===============================================  Author: Christophe@pallier.org  Date: 20 Dec 2012   ``` ## Loading required package: signal ```  ``` ## Loading required package: MASS ```  ``` ## Attaching package: 'signal' ```  ``` ## The following object(s) are masked from 'package:stats': ##  ## filter, poly ```   First, we generate a paradigm with a fixed SOA.   ```r ncond <- 5 trialpercond <- 10 ntrials <- ncond * trialpercond conditions <- sample(rep(1:ncond, trialpercond))  SOA <- 10  # in seconds onsets <- (1:ntrials - 1) * SOA  stimduration <- 6  # in seconds durations <- rep(stimduration, ntrials) totalduration <- max(onsets) + 20  plot(onsets, rep(1, ntrials), col = conditions, type = "h", ylim = c(0, 1.5),      ylab = "") ```  ![plot of chunk unnamed-chunk-2](figure/unnamed-chunk-2.png)   ```r timing <- data.frame(onsets, conditions, durations) # write.csv(timing, 'timing.csv') head(timing) ```  ``` ##   onsets conditions durations ## 1      0          3         6 ## 2     10          4         6 ## 3     20          1         6 ## 4     30          5         6 ## 5     40          2         6 ## 6     50          4         6 ```   Reading timing information from the csv file, we build and plot the design matrix   ```r # timing <- read.csv('timing.csv') condnames <- sort(unique(timing$conditions)) ncond <- length(condnames)  regressor <- vector("list", ncond) for (cond in 1:ncond) {     select <- timing$conditions == condnames[cond]     print(cond)     print(timing$onsets[select])     regressor[[cond]] <- hrf(list(onsets = timing$onsets[select], durations = timing$durations[select]),          totalduration) } ```  ``` ## [1] 1 ##  [1]  20  80 120 130 160 250 360 370 450 460 ## [1] 2 ##  [1]  40  70 150 170 290 300 320 330 380 420 ## [1] 3 ##  [1]   0 180 220 230 260 310 340 390 400 430 ## [1] 4 ##  [1]  10  50  90 100 210 270 280 350 410 490 ## [1] 5 ##  [1]  30  60 110 140 190 200 240 440 470 480 ```  ```r  names(regressor) <- condnames X <- as.matrix(as.data.frame(regressor)) npoints <- nrow(X) matplot(1:nrow(X), X, type = "l", col = 1:ncond) ```  ![plot of chunk generateDesignMat](figure/generateDesignMat.png)      Simulations and Estimation by an hrf model.  ------------------------------------------  We simulate a voxel where the signal increase in a linear fashion with 'cond' (1:5)   ```r betas <- 1:ncond y0 <- 10 + X %*% betas nsim <- 100 estimates <- matrix(nrow = nsim, ncol = ncond) for (sim in 1:nsim) {     fmri.noise <- pink.noise(npoints)     y <- y0 + 20 * fmri.noise     estimates[sim, ] <- coef(lm(y ~ X))[-1] } plot(y, col = "black") lines(y0, col = "red") ```  ![plot of chunk simul](figure/simul1.png)   ```r es <- data.frame(estimates = apply(estimates, 2, mean), sd = apply(estimates,      2, sd)) es ```  ``` ##   estimates     sd ## 1     1.013 0.5406 ## 2     2.087 0.6197 ## 3     3.077 0.5401 ## 4     4.028 0.4793 ## 5     4.996 0.5425 ```  ```r plot(1:nrow(es), es[, 1], pch = 16, col = "black", ylim = c(0, 6)) segments(1:nrow(es), es[, 1] - es[, 2], 1:nrow(es), es[, 1] + es[, 2]) ```  ![plot of chunk simul](figure/simul2.png)    New design, with jitter between trials: --------------------------------------   ```r SOA <- 10  # in seconds onsets <- (1:ntrials - 1) * SOA + runif(ntrials, min = -2, max = 2)  stimduration <- 6  # in seconds durations <- rep(stimduration, ntrials) totalduration <- max(onsets) + 20  plot(onsets, rep(1, ntrials), col = conditions, type = "h", ylim = c(0, 1.5),      ylab = "") ```  ![plot of chunk unnamed-chunk-3](figure/unnamed-chunk-31.png)   ```r hist(diff(onsets)) ```  ![plot of chunk unnamed-chunk-3](figure/unnamed-chunk-32.png)   ```r timing <- data.frame(onsets, conditions, durations) head(timing) ```  ``` ##   onsets conditions durations ## 1  1.008          3         6 ## 2 11.046          4         6 ## 3 19.957          1         6 ## 4 28.008          5         6 ## 5 40.527          2         6 ## 6 50.549          4         6 ```    ```r # timing <- read.csv('timing.csv') condnames <- sort(unique(timing$conditions)) ncond <- length(condnames)  regressor <- vector("list", ncond) for (cond in 1:ncond) {     select <- timing$conditions == condnames[cond]     print(cond)     print(timing$onsets[select])     regressor[[cond]] <- hrf(list(onsets = timing$onsets[select], durations = timing$durations[select]),          totalduration) } ```  ``` ## [1] 1 ##  [1]  19.96  79.50 120.50 130.64 158.63 248.78 361.22 370.52 448.42 460.62 ## [1] 2 ##  [1]  40.53  70.00 148.33 168.92 290.76 298.70 318.09 330.63 381.87 420.95 ## [1] 3 ##  [1]   1.008 181.317 221.343 230.253 259.851 309.494 338.258 389.052 ##  [9] 399.622 429.900 ## [1] 4 ##  [1]  11.05  50.55  88.06  99.29 210.33 268.40 278.90 350.27 409.71 489.08 ## [1] 5 ##  [1]  28.01  61.81 111.85 140.97 188.92 198.56 241.45 439.25 471.22 479.11 ```  ```r  names(regressor) <- condnames X <- as.matrix(as.data.frame(regressor)) npoints <- nrow(X) matplot(1:nrow(X), X, type = "l", col = 1:ncond) ```  ![plot of chunk generateDesignMat](figure/generateDesignMat.png)     ```r betas <- 1:ncond y0 <- 10 + X %*% betas nsim <- 100 estimates <- matrix(nrow = nsim, ncol = ncond) for (sim in 1:nsim) {     fmri.noise <- pink.noise(npoints)     y <- y0 + 20 * fmri.noise     estimates[sim, ] <- coef(lm(y ~ X))[-1] } plot(y, col = "black") lines(y0, col = "red") ```  ![plot of chunk simul](figure/simul1.png)   ```r es <- data.frame(estimates = apply(estimates, 2, mean), sd = apply(estimates,      2, sd)) es ```  ``` ##   estimates     sd ## 1     1.097 0.5234 ## 2     1.985 0.5443 ## 3     2.970 0.5510 ## 4     4.049 0.5112 ## 5     5.025 0.4782 ```  ```r plot(1:nrow(es), es[, 1], pch = 16, col = "black", ylim = c(0, 6)) segments(1:nrow(es), es[, 1] - es[, 2], 1:nrow(es), es[, 1] + es[, 2]) ```  ![plot of chunk simul](figure/simul2.png)  